# Пошаговая реализация: от семей к группам

> Каждый этап — минимальное изменение, проверяемое на фронте.
> После каждого этапа приложение должно работать.
> Ссылка на архитектуру: `doc/09_Groups_Migration_Plan.md`

---

## Фаза 1: Подготовка БД (старый UI продолжает работать)

### Этап 1. Новые таблицы групп

**Что делаем:**
- SQL-миграция `supabase/add_groups_tables.sql`:
  - `SECURITY DEFINER` функции: `get_user_group_ids()`, `get_user_admin_group_ids()`
  - CREATE TABLE: `groups`, `group_members`, `group_invites`, `group_decks`
  - Индексы (7 штук, см. план 09)
  - RLS-политики для всех новых таблиц (см. раздел 3.3 плана)
- Применить миграцию в Supabase

**Как проверить:**
1. Открыть Supabase Dashboard → Table Editor
2. Убедиться: таблицы `groups`, `group_members`, `group_invites`, `group_decks` существуют
3. Открыть SQL Editor → выполнить: `SELECT get_user_group_ids('00000000-0000-0000-0000-000000000000');` → должен вернуть пустой результат (не ошибку)
4. Открыть приложение → **всё работает как раньше** (старый UI без изменений)

**Готово когда:** таблицы и функции созданы, приложение не сломалось.

---

### Этап 2. Колонка `owner_id` на `decks`

**Что делаем:**
- SQL-миграция:
  - `ALTER TABLE decks ADD COLUMN owner_id UUID REFERENCES profiles(id)`
  - Заполнить: `UPDATE decks SET owner_id = created_by WHERE created_by IS NOT NULL`
  - Для записей без `created_by`: найти admin семьи → использовать его ID
  - `ALTER TABLE decks ALTER COLUMN owner_id SET NOT NULL`
- Добавить новые RLS-политики для `decks` и `cards` по `owner_id` (не удаляя старые по `family_id`)
- Добавить RLS "Users can view decks/cards they study" (через `user_cards`)

**Как проверить:**
1. Supabase → Table Editor → `decks` → колонка `owner_id` заполнена у всех записей
2. SQL Editor: `SELECT id, title, owner_id, family_id FROM decks;` → owner_id NOT NULL у всех
3. Приложение → **всё работает как раньше**

**Готово когда:** owner_id заполнен, новые RLS добавлены, старые RLS не тронуты.

---

### Этап 3. `profiles.family_id` → nullable

**Что делаем:**
- SQL: `ALTER TABLE profiles ALTER COLUMN family_id DROP NOT NULL`

**Как проверить:**
1. Приложение → залогиниться существующим пользователем → **всё работает**
2. Supabase → profiles → family_id по-прежнему заполнен у существующих пользователей

**Готово когда:** миграция применена, существующие пользователи не затронуты.

---

## Фаза 2: Новая регистрация

### Этап 4. Регистрация без семьи

**Что делаем:**
- `src/app/api/register/route.ts`:
  - Не создаёт запись в `families`
  - Создаёт profile с `family_id = NULL`, `role = 'admin'` (временно, для совместимости)
  - Убрать параметр `familyName` из запроса
- `src/app/(auth)/register/page.tsx`:
  - Убрать поле "Имя семьи"
  - Редирект после регистрации → `/login` (пока оставляем, на `/dashboard` переключим позже)

**Как проверить:**
1. Открыть `/register` → поля "Имя семьи" нет
2. Зарегистрировать нового пользователя (email + пароль + имя)
3. Залогиниться → попадаем в старый admin-интерфейс (`/admin/decks`)
4. Supabase → profiles → новый пользователь: `family_id = NULL`, `role = 'admin'`
5. Supabase → families → новой записи нет
6. Старый пользователь → залогиниться → **всё работает как раньше**

**Готово когда:** новые пользователи создаются без семьи, старые не затронуты.

---

## Фаза 3: Новые единые страницы (доступны по прямому URL, старый UI ещё работает)

> В этой фазе мы создаём новые страницы по новым путям.
> Старый UI (`/admin/*`, `/student/*`) продолжает работать.
> Новые страницы можно открыть по прямой ссылке для проверки.

### Этап 5. AuthContext + RequireAuth + Header (подготовка)

**Что делаем:**
- `src/contexts/AuthContext.tsx`:
  - Тип Profile: убрать `role` и `family_id`
  - Убрать `isAdmin` из контекста
  - Запрос профиля: `SELECT id, display_name, avatar_url, show_russian_transcription`
- `src/components/auth/RequireAuth.tsx`:
  - Убрать параметр `role`
  - Только проверка авторизации (есть user → пропустить, нет → `/login`)
- `src/components/layout/Header.tsx`:
  - Единая навигация: Наборы (`/decks`), Группы (`/groups`), Повторение (`/review`), Профиль
  - Убрать условную логику по `role`
- Обновить `src/app/admin/layout.tsx` и `src/app/student/layout.tsx`:
  - Убрать `role` из `RequireAuth` (оставить просто `<RequireAuth>`)

**Как проверить:**
1. Залогиниться любым пользователем
2. Header: пункты "Наборы", "Группы", "Повторение" (единые для всех)
3. Навигация по Header → пока 404 на новых путях (страницы создадим далее)
4. Старые страницы `/admin/decks`, `/student/decks` → **всё ещё работают** (RequireAuth больше не проверяет роль)

**Готово когда:** Header единый, RequireAuth без ролей, AuthContext без role/family_id.

---

### Этап 6. Dashboard + список колод

**Что делаем:**
- `src/app/dashboard/page.tsx`:
  - Блок "Мои наборы": `SELECT * FROM decks WHERE owner_id = auth.uid()`
  - Блок "Наборы из групп": `SELECT d.* FROM decks d JOIN group_decks gd ... JOIN group_members gm ... WHERE gm.user_id = auth.uid() AND d.owner_id != auth.uid()`
  - Блок "Повторение": количество карточек к повторению + кнопка "Начать"
  - Ссылки на каждую колоду → `/decks/[id]`
- `src/app/decks/page.tsx`:
  - Список личных колод (owner_id = auth.uid())
  - Кнопка "+ Создать"
- `src/app/(auth)/login/page.tsx`:
  - Редирект после логина → `/dashboard` (вместо role-based)
- Обновить корневой `src/app/page.tsx`:
  - Если авторизован → редирект на `/dashboard`

**Как проверить:**
1. Залогиниться → попадаем на `/dashboard`
2. Видим блок "Мои наборы" с колодами (если они есть у пользователя)
3. Видим блок "Повторение" с количеством карточек
4. Клик на "Наборы" в Header → `/decks` → список колод
5. Новый пользователь (без колод) → пустой dashboard с кнопкой "Создать набор"

**Готово когда:** dashboard и список колод работают, логин ведёт на /dashboard.

---

### Этап 7. CRUD колод и карточек

**Что делаем:**
- `src/app/decks/new/page.tsx` — создать колоду (owner_id = auth.uid())
- `src/app/decks/[id]/page.tsx` — детали колоды: список карточек + кнопки режимов обучения + SRS-прогресс
- `src/app/decks/[id]/edit/page.tsx` — редактирование колоды
- `src/app/decks/[id]/cards/new/page.tsx` — добавить карточку
- `src/app/decks/[id]/cards/bulk/page.tsx` — массовое создание
- `src/app/decks/[id]/cards/[cardId]/edit/page.tsx` — редактирование карточки

> Основа — существующие страницы из `/admin/decks/*`, адаптированные:
> - Запросы по `owner_id` вместо `family_id`
> - Убрать проверки `role`

**Как проверить:**
1. `/decks` → "+ Создать" → заполнить → создать → появилась в списке
2. Клик на колоду → `/decks/[id]` → видим карточки, SRS-прогресс, кнопки обучения
3. "Редактировать" → изменить название → сохранить → название обновилось
4. "Добавить карточку" → создать → появилась в списке
5. "Массовое создание" → ввести несколько → все созданы
6. Клик на карточку → редактировать → сохранить → обновилась
7. Supabase: новая колода имеет `owner_id = auth.uid()`, `family_id = NULL`

**Готово когда:** полный CRUD колод и карточек работает через новые страницы.

---

### Этап 8. Режимы обучения

**Что делаем:**
- `src/app/decks/[id]/study/page.tsx` — изучение (просмотр карточек)
- `src/app/decks/[id]/test/page.tsx` — тесты (choice → audio → dictation)
- `src/app/decks/[id]/review/page.tsx` — SRS-повторение по колоде
- `src/app/decks/[id]/dictation/page.tsx` — диктант
- `src/app/decks/[id]/complete/page.tsx` — экран завершения

> Основа — существующие страницы из `/student/decks/[id]/*`
> SRS-логика (`src/lib/srs/*`) не меняется.

**Как проверить:**
1. Открыть колоду → "Изучение" → карточки показываются, "Знаю" / "Не знаю" работает
2. "Тест" → выбор варианта → правильно/неправильно → переход к следующему типу
3. "Повторение" → карточки к повторению (если есть) → оценки работают
4. "Диктант" → ввод текста → проверка → результат
5. После завершения → экран complete → кнопка "Вернуться к колоде"
6. SRS-прогресс на странице колоды обновляется после тестов

**Готово когда:** все 4 режима обучения работают на новых путях.

---

### Этап 9. Глобальное повторение

**Что делаем:**
- `src/app/review/page.tsx` — главная повторения (сколько карточек готовы, из каких колод)
- `src/app/review/start/page.tsx` — сессия повторения
- `src/app/review/complete/page.tsx` — завершение повторения

> Основа — `/student/review/*`. Запрос карточек уже по `user_id` (не зависит от family).

**Как проверить:**
1. Header → "Повторение" → `/review`
2. Видим количество карточек к повторению (из всех колод)
3. "Начать" → сессия повторения → оценки → завершение
4. Вернуться на /dashboard → счётчик повторения обновился

**Готово когда:** глобальное повторение работает, включает карточки из всех источников.

---

### Этап 10. Миграция TTS-путей

**Что делаем:**
- `src/lib/tts/tts-server.ts`:
  - Убрать `familyId` из `TtsGenerateOptions`
  - Путь: `/tts/{deckId}/{cardId}_{lang}.wav` (без familyId)
  - Обновить `deleteTtsFiles()`, `ttsFileExists()` — убрать параметр familyId
- Обновить все вызовы TTS-функций в приложении — убрать передачу familyId
- Скрипт миграции файлов: переместить `/public/tts/{familyId}/{deckId}/` → `/public/tts/{deckId}/`
- Удалить пустые директории `{familyId}`

**Как проверить:**
1. Открыть колоду с существующими TTS-файлами → аудио играет
2. Создать новую карточку → сгенерировать TTS → аудио играет
3. Проверить на диске: файлы лежат в `/public/tts/{deckId}/`, а не в `/public/tts/{familyId}/{deckId}/`
4. Диктант → аудио проигрывается корректно

**Готово когда:** TTS работает по новым путям, старые файлы перемещены.

---

## Фаза 4: Миграция данных и удаление старого

### Этап 11. Миграция существующих семей в группы

**Что делаем:**
- SQL-скрипт миграции:
  - Для каждой семьи с >1 участником:
    - Создать `groups` запись (name = families.name)
    - Добавить admin семьи как `group_members(role='admin')`
    - Добавить students семьи как `group_members(role='member')`
    - Все колоды семьи → `group_decks`
  - Одиночные пользователи: ничего не делаем (у них уже есть owner_id на колодах)

**Как проверить:**
1. Supabase → `groups` → записи для каждой семьи с >1 участником
2. Supabase → `group_members` → admin и students правильно привязаны
3. Supabase → `group_decks` → колоды семьи привязаны к группе
4. Залогиниться студентом → /dashboard → видим колоды семьи в блоке группы
5. Залогиниться админом → /dashboard → свои колоды в "Мои наборы" + те же колоды в блоке группы

**Готово когда:** все семьи мигрированы в группы, студенты видят колоды через группы.

---

### Этап 12. Удаление старого кода

**Что делаем:**
- Удалить страницы:
  - `src/app/admin/*` (весь каталог)
  - `src/app/student/*` (весь каталог)
  - `src/app/onboarding/*` (весь каталог)
  - `src/app/register/success/page.tsx` (если существует)
- Удалить API-роуты:
  - `src/app/api/create-children/route.ts`
  - `src/app/api/get-children/route.ts`
  - `src/app/api/update-child/route.ts`
  - `src/app/api/admin/child-stats/route.ts`
- Очистить `.next/types` кэш (если TypeScript ругается)

**Как проверить:**
1. `npm run build` или `npx tsc --noEmit` → нет ошибок (или только pre-existing)
2. Навигация по приложению → нет 404, все ссылки ведут на новые страницы
3. `/admin/decks` → 404 (ожидаемо, страница удалена)
4. `/student/decks` → 404 (ожидаемо)
5. Все функции работают через новые пути

**Готово когда:** старый код удалён, приложение работает только через новые пути.

---

### Этап 13. Очистка БД

**Что делаем:**
- SQL-миграция:
  - Удалить старые RLS-политики:
    - families: все
    - profiles: "Family members can view profiles"
    - decks: "Family members can view decks", "Admins can manage decks"
    - cards: "Family members can view cards", "Admins can manage cards"
    - user_cards: "Admins can view family children user_cards"
  - Удалить столбцы:
    - `ALTER TABLE profiles DROP COLUMN family_id`
    - `ALTER TABLE profiles DROP COLUMN role`
    - `ALTER TABLE decks DROP COLUMN family_id`
    - `ALTER TABLE decks DROP COLUMN created_by`
  - Удалить таблицу:
    - `DROP TABLE families`
  - Удалить старые индексы: `idx_profiles_family_id`, `idx_profiles_role`, `idx_decks_family_id`

**Как проверить:**
1. Supabase → Table Editor → таблицы `families` нет
2. `profiles` → нет колонок `family_id`, `role`
3. `decks` → нет колонок `family_id`, `created_by`
4. Приложение → залогиниться → /dashboard → колоды на месте
5. Создать колоду → работает
6. Пройти тест → прогресс сохраняется
7. Глобальное повторение → работает

**Готово когда:** все legacy-столбцы и таблицы удалены, приложение полностью на новой схеме.

---

## Фаза 5: Группы (новый функционал)

### Этап 14. Создание групп + инвайты

**Что делаем:**
- API:
  - `POST /api/groups` — создание группы + авто-добавление создателя как admin
  - `POST /api/groups/join` — вступление по инвайт-коду (service role)
  - `POST /api/groups/[id]/leave` — выход из группы (с логикой "последний админ")
- Страницы:
  - `src/app/groups/page.tsx` — список моих групп
  - `src/app/groups/new/page.tsx` — создать группу (имя, описание, `deck_add_permission`)
  - `src/app/groups/join/[inviteCode]/page.tsx` — вступить по ссылке
  - `src/app/groups/[id]/page.tsx` — страница группы (участники, колоды)
  - `src/app/groups/[id]/settings/page.tsx` — настройки (админ): имя, описание, права, участники (promote, удалить), инвайты

**Как проверить:**
1. Header → "Группы" → `/groups` → пустой список + "Создать группу"
2. Создать группу "Тестовая" → группа появилась в списке
3. Открыть группу → настройки → создать инвайт → получить ссылку
4. **В другом браузере/инкогнито:** зарегистрировать нового пользователя
5. Перейти по инвайт-ссылке → "Вступить?" → подтвердить → попадаем в группу
6. Оба пользователя видят друг друга в списке участников
7. Админ: настройки → видит участника → может "Назначить админом"
8. Участник: нет доступа к настройкам группы
9. Участник: "Выйти из группы" → группа пропала из списка
10. Вступить снова по ссылке → всё ок

**Готово когда:** полный цикл создания, вступления, выхода из группы работает.

---

### Этап 15. Колоды в группах

**Что делаем:**
- Страница группы (`/groups/[id]`):
  - Список колод группы
  - Кнопка "Добавить колоду" (если разрешено по `deck_add_permission`)
  - Модалка/страница выбора колоды для добавления в группу
  - Кнопка "Убрать колоду" (админ или тот, кто добавил)
  - Бейдж "New" на новых колодах (по `last_seen_at`)
  - Обновление `last_seen_at` при посещении
- Страница колоды (`/decks/[id]`):
  - Если владелец: показать к каким группам привязана
- Dashboard:
  - Групповые колоды показаны в отдельных блоках по группам (вместо плоского списка)
  - Бейдж "New" на группе, если есть новые колоды

**Как проверить:**
1. Админ группы: создать личную колоду → открыть группу → "Добавить колоду" → выбрать → колода в списке группы
2. Другой участник: /dashboard → видит колоду в блоке группы
3. Участник: открыть групповую колоду → может учить (study, test, review, dictation)
4. Участник: НЕ может редактировать карточки чужой колоды (нет кнопки "Редактировать")
5. SRS-прогресс сохраняется для участника (проверить в Supabase: user_cards)
6. Группа с `deck_add_permission = 'all_members'`: участник может добавить и убрать свою колоду
7. Группа с `deck_add_permission = 'admin_only'`: участник не видит кнопку "Добавить колоду"
8. Dashboard: видим отдельный блок для каждой группы с её колодами

**Готово когда:** колоды добавляются/убираются из групп, участники учатся по ним, прогресс сохраняется.

---

### Этап 16. Статистика группы

**Что делаем:**
- `src/app/groups/[id]/stats/page.tsx` — сводка: список участников + общий прогресс каждого
- `src/app/groups/[id]/stats/[userId]/page.tsx` — детальная статистика участника по колодам группы
- На странице группы: вкладка/ссылка "Статистика" (видна только админу)

**Как проверить:**
1. Админ группы: открыть группу → "Статистика"
2. Видим список участников с % прогресса по каждому
3. Клик на участника → детальная статистика: по колодам, по статусам (new/learning/young/mature...)
4. Участник (не-админ): вкладки "Статистика" нет
5. Участник: попытка открыть `/groups/[id]/stats` напрямую → нет данных (RLS не пускает)

**Готово когда:** админ видит прогресс участников, участники не видят чужую статистику.

---

## Фаза 6: Финализация

### Этап 17. Регрессионное тестирование

**Что делаем:**
- Ручная проверка всех сценариев из разных ролей

**Чеклист:**
- [ ] Регистрация нового пользователя → /dashboard → пустой → создать колоду → учить
- [ ] Создать группу → пригласить → другой пользователь вступает
- [ ] Добавить колоду в группу → участник видит и учит
- [ ] Участник выходит из группы → прогресс сохраняется → карточки в глобальном повторении
- [ ] Убрать колоду из группы → прогресс участников сохраняется
- [ ] Удалить группу → колоды и прогресс остаются
- [ ] Пользователь А не видит личные колоды пользователя Б
- [ ] Участник не видит личные колоды админа (только расшаренные)
- [ ] Не-участник не видит колоды группы (ни через UI, ни через Supabase client)
- [ ] `admin_only` группа: участник не может добавить колоду
- [ ] `all_members` группа: участник может добавить и убрать свою колоду
- [ ] Последний админ уходит → все участники становятся админами
- [ ] TTS: аудио проигрывается на всех типах карточек
- [ ] Глобальное повторение: включает карточки из личных и групповых колод
- [ ] SRS-прогресс: все 6 статусов переходят корректно
- [ ] Инвайт-код: expired инвайт → не работает; деактивированный → не работает

**Готово когда:** все пункты чеклиста пройдены.

---

### Этап 18. Обновление документации

**Что делаем:**
- `doc/01_PRD_Requirements.md` — новая ролевая модель, группы
- `doc/03_Architecture_Database.md` — новая ERD, таблицы, RLS
- `doc/05_Project_Structure.md` — новая структура каталогов
- `doc/09_Groups_Migration_Plan.md` — отметить все шаги как выполненные

**Готово когда:** документация соответствует текущему состоянию приложения.

---

## Порядок выполнения и зависимости

```
Фаза 1 (БД):        1 → 2 → 3
Фаза 2 (Регистрация):        4
Фаза 3 (Новый UI):  5 → 6 → 7 → 8 → 9 → 10
Фаза 4 (Миграция):  11 → 12 → 13
Фаза 5 (Группы):    14 → 15 → 16
Фаза 6 (Финал):     17 → 18
```

**Зависимости между фазами:**
- Фаза 2 требует: Фаза 1 (этап 3)
- Фаза 3 требует: Фаза 1 (этапы 1-2)
- Фаза 4 требует: Фаза 3 полностью
- Фаза 5 требует: Фаза 4 полностью
- Фаза 6 требует: Фаза 5 полностью

**Фазы 2 и 3 можно начинать параллельно** (обе зависят только от Фазы 1).
