# Техническое задание: Система интервальных повторений для изучения карточек

## Цель
Реализовать backend-логику для приложения изучения слов с использованием метода интервальных повторений (Spaced Repetition System) на основе алгоритма SuperMemo 2.

## Контекст
В проекте уже существует базовая функциональность карточек и тестов. Необходимо проанализировать текущую реализацию и интегрировать новую логику статусов и интервальных повторений.

## Основной пользовательский сценарий

Процесс изучения всегда линейный и состоит из трёх этапов:

1. **Просмотр карточек** - пользователь листает карточки набора и отмечает "Знаю" или "Не знаю"
2. **Прохождение тестов** - пользователь тестируется по карточкам, которые отметил как "Знаю"
3. **Повторение** - система автоматически показывает выученные карточки для повторения по расписанию

## Статусы карточек

Каждая карточка пользователя проходит через lifecycle статусов:

### new
- Начальный статус
- Карточка добавлена в набор, но пользователь её ещё не начал изучать
- Показывается в режиме "Просмотр карточек"

### learning
- Пользователь отметил карточку "Знаю" хотя бы один раз
- Карточка ещё не прошла все тесты или была ошибка в тестах
- Показывается в режиме "Просмотр карточек" и "Тесты"

### testing
- Карточка прошла минимум один из трёх тестов
- Продолжает проходить оставшиеся тесты
- Показывается только в режиме "Тесты"

### young
- Карточка выучена (прошла все 3 теста успешно)
- Интервал повторения меньше 21 дня
- Показывается только в режиме "Повторение" когда наступает время next_review_at

### mature
- Карточка хорошо усвоена
- Интервал повторения 21 день и больше
- Показывается только в режиме "Повторение" когда наступает время next_review_at

### relearning
- Карточка была выучена (young или mature), но пользователь ошибся в повторении
- Карточка учится заново - нужно снова отметить "Знаю" и пройти все 3 теста
- Показывается в режиме "Просмотр карточек" и "Тесты"

## Типы тестов

В приложении существует 3 типа тестов разной сложности:

1. **choice** - выбор правильного перевода из вариантов ответа
2. **audio** - выбор правильного варианта после прослушивания аудио
3. **dictation** - написание слова под диктовку (аудио)

### Важные правила для тестов:

**Для первичного изучения (learning → young):**
- Тесты должны проходиться строго в порядке: choice → audio → dictation
- Карточка выпускается в статус young только после успешного прохождения ВСЕХ ТРЁХ тестов
- При любой ошибке в любом тесте - все тесты сбрасываются, карточка возвращается в learning
- Пользователю нужно снова отметить "Знаю" и пройти все тесты заново

**Для повторения (young/mature/relearning):**
- Показывается только ОДИН случайный тест из трёх
- При правильном ответе применяется алгоритм интервальных повторений
- При ошибке карточка переходит в relearning и нужно снова пройти все 3 теста

## Данные для каждой карточки пользователя

Необходимо хранить следующую информацию:

### Основные поля
- ID карточки пользователя (user_card_id)
- ID исходной карточки (card_id)
- ID пользователя (user_id)
- ID набора карточек (deck_id)
- Текущий статус (status)

### Интервальное повторение
- ease_factor - множитель интервала для алгоритма SM-2 (начальное значение 2.5, минимум 1.3)
- interval_days - текущий интервал в днях до следующего повторения
- next_review_at - дата и время когда нужно показать карточку для повторения

### Счётчики и статистика
- reviews_count - общее количество повторений (тестов)
- correct_streak - количество правильных ответов подряд (используется только в learning)
- lapses_count - количество раз когда пользователь забыл слово (ошибка в young/mature)

### Результаты первичных тестов
- test_choice_passed - пройден ли тест с выбором варианта (boolean)
- test_audio_passed - пройден ли аудио тест (boolean)
- test_dictation_passed - пройден ли диктант (boolean)
- test_choice_attempts - количество попыток теста choice
- test_audio_attempts - количество попыток теста audio
- test_dictation_attempts - количество попыток теста dictation

### Временные метки флоу
- last_seen_in_study - когда последний раз смотрел карточку в режиме просмотра
- marked_know_at - когда отметил "Знаю" (если NULL - нужно снова отметить)
- last_test_type - тип последнего теста ('choice', 'audio', 'dictation')
- last_test_result - результат последнего теста (boolean)
- created_at - когда карточка добавлена пользователю
- updated_at - последнее обновление
- graduated_at - когда карточка впервые перешла в статус young

## Функциональные требования

### 1. Режим просмотра карточек (Study Mode)

**Цель:** Пользователь просматривает новые и повторяемые карточки, отмечая какие он знает.

**Какие карточки показывать:**
- Статус = new или learning
- У которых marked_know_at пустой ИЛИ последний тест был неудачным (last_test_result = false)
- Сортировать: сначала new, потом learning, внутри каждой группы по дате создания

**Действия пользователя:**
- Нажимает "Знаю" - устанавливается marked_know_at = текущее время, статус меняется на learning если был new
- Нажимает "Не знаю" - marked_know_at сбрасывается в NULL, статус = learning

**Ограничения:** Нет ограничений на количество карточек за сессию.

### 2. Режим тестирования - Первичное изучение

**Цель:** Пользователь проходит три типа тестов по карточкам, которые отметил как "Знаю".

**Какие карточки показывать:**
- Статус = learning или testing
- marked_know_at не пустой (отмечено "Знаю")
- Есть хотя бы один непройденный тест (test_choice_passed = false ИЛИ test_audio_passed = false ИЛИ test_dictation_passed = false)
- Сортировать по порядку тестов: сначала те, где не пройден choice, потом audio, потом dictation

**Определение типа теста:**
- Если test_choice_passed = false, показываем тест choice
- Иначе если test_audio_passed = false, показываем тест audio
- Иначе если test_dictation_passed = false, показываем тест dictation

**Обработка правильного ответа:**
- Увеличиваем счётчик попыток (test_X_attempts)
- Устанавливаем флаг test_X_passed = true
- Увеличиваем reviews_count
- Проверяем все ли три теста пройдены (все три passed = true)
- Если ДА - переводим карточку в статус young:
  - status = young
  - graduated_at = текущее время
  - interval_days = 1
  - next_review_at = текущее время + 1 день
  - Сбрасываем все три test_X_passed в false (для будущего relearning)
- Если НЕТ и это первый пройденный тест - переводим из learning в testing

**Обработка неправильного ответа:**
- Увеличиваем счётчик попыток (test_X_attempts)
- Увеличиваем reviews_count
- Сбрасываем ВСЕ три флага test_X_passed в false
- Статус возвращаем в learning
- Сбрасываем marked_know_at в NULL (пользователь должен снова отметить "Знаю")
- Сбрасываем correct_streak в 0

**Ограничения:** Максимум 30 тестов за одну сессию (можно настраивать).

### 3. Режим тестирования - Повторение

**Цель:** Пользователь повторяет выученные карточки согласно расписанию интервальных повторений.

**Какие карточки показывать:**
- Статус = young или mature или relearning
- next_review_at <= текущее время (наступило время повторения)
- Сортировать по next_review_at (самые старые первыми)

**Определение типа теста:**
- Выбираем случайный тип из трёх: choice, audio, dictation
- Используем встроенный random для выбора

**Обработка правильного ответа:**

Если статус = relearning:
- Возвращаем карточку обратно в young или mature (зависит от interval_days: если >= 21 то mature, иначе young)
- Уменьшаем интервал: interval_days = interval_days * 0.5 (округляем)
- Устанавливаем next_review_at = текущее время + новый interval_days

Если статус = young или mature:
- Применяем алгоритм SM-2:
  - interval_days = interval_days * ease_factor (округляем)
  - ease_factor остаётся без изменений при правильном ответе
  - Если interval_days >= 21 и статус был young, переводим в mature
  - Устанавливаем next_review_at = текущее время + новый interval_days

Всегда увеличиваем reviews_count.

**Обработка неправильного ответа:**
- Статус меняется на relearning
- Увеличиваем lapses_count (счётчик забываний)
- Уменьшаем ease_factor: ease_factor = ease_factor - 0.2, но не ниже минимума 1.3
- Сбрасываем interval_days = 1
- Устанавливаем next_review_at = текущее время + 1 день
- Сбрасываем marked_know_at в NULL (нужно снова отметить "Знаю")
- Сбрасываем все три флага test_X_passed в false (нужно пройти все тесты заново)
- Увеличиваем reviews_count

**Ограничения:** Максимум 30 карточек для повторения за одну сессию (можно настраивать).

### 4. Статистика по набору

Необходимо предоставить статистику:
- Количество карточек в каждом статусе (new, learning, testing, young, mature, relearning)
- Процент освоения набора = (young + mature) / всего карточек * 100%
- Количество карточек готовых к повторению (next_review_at <= сейчас)
- Количество карточек готовых к тестированию (marked_know_at не NULL и есть непройденные тесты)

## Алгоритм SM-2 (SuperMemo 2)

Базовая логика для интервальных повторений:

### При правильном ответе в повторении:
- Интервал увеличивается: новый_интервал = текущий_интервал * ease_factor
- ease_factor не меняется (остаётся как был)
- Если новый_интервал >= 21 дня и карточка была young, переводим в mature

### При неправильном ответе в повторении:
- Интервал сбрасывается в 1 день
- ease_factor уменьшается: ease_factor = ease_factor - 0.2
- Минимальное значение ease_factor = 1.3 (не может быть меньше)
- Карточка переходит в relearning

### Начальные значения:
- ease_factor = 2.5
- interval_days = 1 (после первого выпуска в young)

## Задачи для реализации

1. **Анализ существующей структуры:**
   - Изучить текущую схему базы данных для карточек
   - Определить какие поля уже существуют, какие нужно добавить
   - Проанализировать существующие API endpoints
   - Определить как интегрировать новую логику с минимальными изменениями

2. **Обновление схемы данных:**
   - Добавить необходимые поля в таблицу user_cards (или аналогичную)
   - Создать индексы для оптимизации запросов по статусам и датам повторений
   - Добавить миграцию для существующих данных если нужно

3. **Реализация бизнес-логики:**
   - Функция обработки "Знаю"/"Не знаю" в режиме просмотра
   - Функция определения следующего типа теста
   - Функция обработки результата теста для первичного изучения
   - Функция обработки результата теста для повторения
   - Функция расчёта следующей даты повторения по SM-2

4. **API endpoints (обновить или создать):**
   - GET карточек для просмотра
   - POST отметка "Знаю"/"Не знаю"
   - GET карточек для тестирования (с определением типа теста)
   - POST результат теста
   - GET статистика по набору

5. **Валидация и обработка ошибок:**
   - Проверка что пользователь не может отправить результат теста для карточки в неправильном статусе
   - Обработка race conditions при одновременных запросах
   - Логирование переходов между статусами для отладки

## Приоритеты
1. Корректность логики статусов и переходов - критично
2. Правильная работа интервальных повторений - критично
3. Производительность запросов - важно
4. Удобство отладки и логирование - желательно

## Ограничения и допущения
- Один пользователь не может одновременно работать с одной карточкой из разных устройств (race conditions)
- Максимальный интервал повторения не ограничен (может быть год и больше)
- Время хранится с учётом часового пояса пользователя
- Нет ограничения на количество карточек в наборе